<!DOCTYPE html>
<html lang="en">
<head>
    <title>WMS</title>

    <link rel="shortcut icon" type="image/x-icon" href="/static/assets/img/favicon.png">

    <link rel="stylesheet" href="/static/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/assets/css/animate.css">
    <link rel="stylesheet" href="/static/assets/plugins/owlcarousel/owl.carousel.min.css">
    <link rel="stylesheet" href="/static/assets/plugins/owlcarousel/owl.theme.default.min.css">
    <link rel="stylesheet" href="/static/assets/plugins/select2/css/select2.min.css">
    <link rel="stylesheet" href="/static/assets/css/bootstrap-datetimepicker.min.css">
    <link rel="stylesheet" href="/static/assets/plugins/fontawesome/css/fontawesome.min.css">
    <link rel="stylesheet" href="/static/assets/plugins/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="/static/assets/css/style.css">
</head>
<body>
<div id="global-loader">
    <div class="whirly-loader"></div>
</div>
<div class="main-wrappers">

    <div class="header">

        <div class="header-left border-0 ">
            <a href="/" class="logo">
                <img src="/static/assets/img/logo.png" alt="">
            </a>
            <a href="/" class="logo-small">
                <img src="/static/assets/img/logo-small.png" alt="">
            </a>
        </div>


        <ul class="nav user-menu">
            <li class="nav-item dropdown has-arrow main-drop">
                <a href="javascript:void(0);" class="dropdown-toggle nav-link userset" data-bs-toggle="dropdown">
                    <span class="user-img"><img src="/static/assets/img/profiles/avator1.jpg" alt="">
                    <span class="status online"></span></span>
                </a>
                <div class="dropdown-menu menu-drop-user">
                    <div class="profilename">
                        <div class="profileset">
                            <span class="user-img"><img src="/static/assets/img/profiles/avator1.jpg" alt="">
                                <span class="status online"></span>
                            </span>
                            <div class="profilesets">
                                <h6>{{ session['name'] }}</h6>
                                {#                                <h5>Admin</h5>#}
                            </div>
                        </div>
                        <hr class="m-0">
                        <a class="dropdown-item" href="/register/profile">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-user me-2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            My Profile</a>
                        <a class="dropdown-item" href="/client/order/history">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                 stroke-linejoin="round" class="feather feather-settings me-2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                            Order History</a>
                        <hr class="m-0">
                        <a class="dropdown-item logout pb-0" href="/logout"><img
                                src="/static/assets/img/icons/log-out.svg"
                                class="me-2" alt="img">Logout</a>
                    </div>
                </div>
            </li>
        </ul>


        <div class="dropdown mobile-user-menu">
            <a href="javascript:void(0);" class="nav-link dropdown-toggle" data-bs-toggle="dropdown"
               aria-expanded="false"><i class="fa fa-ellipsis-v"></i></a>
            <div class="dropdown-menu dropdown-menu-right">
                <a class="dropdown-item" href="#">My Profile</a>
                <a class="dropdown-item" href="#">Settings</a>
                <a class="dropdown-item" href="/logout">Logout</a>
            </div>
        </div>
    </div>

    <div class="page-wrapper ms-0">
        <div class="content">
            <div class="row">
                <div class="col-lg-8 col-sm-12 tabs_wrapper">
                    <div class="page-header ">
                        <div class="page-title">
                            <h4>View Products</h4>
                            <h6>Create your Orders</h6>
                        </div>
                    </div>
                    <div class="tabs_container">
                        <div class="tab_content active" data-tab="Accessories">
                            <div class="row">
                                {% for product in products %}
                                    <div class="col-lg-3 col-sm-6 d-flex ">
                                        <div class="productset flex-fill">
                                            <div class="productsetimg">
                                                <img src="/{{ product.image }}" alt="img">
                                                <h6>Qty: {{ product.stock_qty }}</h6>
                                                {#                                                <div class="check-product">#}
                                                {#                                                    <i class="fa fa-check"></i>#}
                                                {#                                                </div>#}
                                            </div>
                                            <div class="productsetcontent">
                                                {#                                            <h5>Accessories</h5>#}
                                                <h4>{{ product.name }}</h4>
                                                <h6>{{ product.price }}</h6>
                                                <br/>
                                                {#                                                <button class="btn btn-success">#}
                                                {% if product.stock_qty > 0 %}
                                                    <button type="button" class="btn btn-success"
                                                            onclick="addToOrder('{{ product.sku }}', '{{ product.name }}', {{ product.price }}, {{ product.stock_qty }},'{{ product.image }}')">
                                                        Add to Order
                                                    </button>
                                                {% else %}
                                                    <button class="btn btn-danger">Out of Stock</button>
                                                {% endif %}
                                                {#                                                </button>#}
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                    </div>
                </div>


                <div class="col-lg-4 col-sm-12 ">
                    <div class="order-list">
                        <div class="orderid">
                            <h4>Order List</h4>
                            {#                            <h5>Transaction id : #65565</h5>#}
                        </div>
                        {#                        <div class="actionproducts">#}
                        {#                            <ul>#}
                        {#                                <li>#}
                        {#                                    <a href="javascript:void(0);" class="deletebg confirm-text"><img#}
                        {#                                            src="/static/assets/img/icons/delete-2.svg" alt="img"></a>#}
                        {#                                </li>#}
                        {#                            </ul>#}
                        {#                        </div>#}
                    </div>

                    <div class="card card-order">

                        <div class="split-card">
                        </div>
                        <div class="card-body pt-0">
                            <div class="product-table" id="product-lists">
                            </div>
                        </div>
                        <div class="split-card">
                        </div>

                        <div class="card-body pt-0 pb-2">
                            <div class="setvaluecash">
                                <ul>
                                    <li>
                                        <a href="javascript:void(0);" class="paymentmethod" type="radio">
                                            <img src="/static/assets/img/icons/cash.svg" alt="img" class="me-2">
                                            <input type="radio" name="payment" value="Cash"> Cash
                                        </a>
                                    </li>
                                    <li>
                                        <a href="javascript:void(0);" class="paymentmethod" type="radio">
                                            <img src="/static/assets/img/icons/debitcard.svg" alt="img" class="me-2">
                                            <input type="radio" name="payment" value="PayPal"> Online
                                        </a>
                                    </li>
                                </ul>


{#                                <label>#}
{#                                    <input type="radio" name="payment" value="PayPal"> Online#}
{#                                </label>#}
{#                                <label>#}
{#                                    <input type="radio" name="payment" value="Cash"> Cash#}
{#                                </label>#}
                            </div>
                            <div class="btn-totallabel" onclick="submitOrder(event)">
                                <h5>Checkout</h5>
                                <h6 id="total-amount">00.00</h6>
                            </div>
{#                            <button type="button" onclick="submitOrder(event)">Submit Order</button>#}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    let orderList = [];

    // Function to add product to the order_routes list
    function addToOrder(productId, productName, productPrice, stockQty , image) {
        // Check if the product already exists in the order_routes list
        let existingProduct = orderList.find(product => product.id === productId);
        {#console.log(image)#}
        if (existingProduct) {
            // If the product exists, increase its quantity by 1, but not exceeding the available stock
            if (existingProduct.qty < existingProduct.maxQty) {
                existingProduct.qty += 1;
            } else {
                alert('Cannot add more than available stock.');
            }
        } else {
            // Add new product to order_routes list if it doesn't exist
            orderList.push({
                id: productId,
                image:image,
                name: productName,
                price: productPrice,
                qty: 1, // Default quantity
                maxQty: stockQty // Maximum available stock
            });
        }


        renderOrderList();
        calculateTotal();
    }

    // Function to render the order_routes list
    function renderOrderList() {
        let orderListTable = document.getElementById('product-lists');

        if (orderListTable) {
            orderListTable.innerHTML = ''; // Clear the existing order list

            orderList.forEach((product, index) => {
                orderListTable.innerHTML += `
<ul class="product-lists" >
                                    <li>
                                        <div class="productimg">
                                            <div class="productimgs">
                                                <img src="/${product.image}" alt="img">
                                            </div>
                                            <div class="productcontet">
                                                <h4>${product.name}
                                                    <a href="javascript:void(0);" class="ms-2" data-bs-toggle="modal"
                                                       data-bs-target="#edit"><img
                                                            src="/static/assets/img/icons/edit-5.svg"
                                                            alt="img"></a>
                                                </h4>
{#                                                <div class="productlinkset">#}
{#                                                    <h5>PT001</h5>#}
{#                                                </div>#}
                                                <div class="increment-decrement">
                                                    <div class="input-groups">
                                                        <input type="button" value="-" class="button-minus dec button" onclick="changeQty(${index}, 'decrement', ${product.maxQty})">
        <input type="text" value="${product.qty}" name="child" id="quantity-${index}" min="1" max="${product.maxQty}" class="quantity-field" onchange="updateQty(${index}, this.value)">
        <input type="button" value="+" class="button-plus inc button" onclick="changeQty(${index}, 'increment', ${product.maxQty})">

                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li>${product.price}.00</li>
                                    <li><a class="confirm-text" href="javascript:void(0);"><img
                                          onclick="removeFromOrder(${index})"  src="/static/assets/img/icons/delete-2.svg" alt="img"></a></li>
                                </ul>
            `;
            });
        } else {
            console.error("Element with ID 'order-list' not found.");
        }
    }

    {#<tr>#}
    {#    <td></td>#}
    {#    <td></td>#}
    {#    <td>#}
    {#        <input type="number" value="${product.qty}" min="1" max="${product.maxQty}"#}
    {#               onchange="updateQty(${index}, this.value)" />#}
    {#    </td>#}
    {#    <td>#}
    {#        <button type="button" onclick="removeFromOrder(${index})">Remove</button>#}
    {#    </td>#}
    {#</tr>#}

    // Function to update the quantity of a product in the order_routes list
    function updateQty(index, qty) {
        if (qty <= orderList[index].maxQty) {
            orderList[index].qty = parseInt(qty);
        } else {
            alert('Cannot exceed available stock.');
            orderList[index].qty = orderList[index].maxQty;  // Reset to max stock if exceeded
        }
        renderOrderList();
        calculateTotal();
    }

    // Function to remove a product from the order_routes list
    function removeFromOrder(index) {
        orderList.splice(index, 1);
        renderOrderList();
        calculateTotal();
    }

    // Function to calculate the total amount
    function calculateTotal() {
        let total = 0;
        orderList.forEach(product => {
            total += product.price * product.qty;
        });

        document.getElementById('total-amount').innerText = total.toFixed(2);
    }

    // Function to handle order_routes submission
    function submitOrder(event) {
        event.preventDefault();

        // Get the selected payment type
        let paymentType = document.querySelector('input[name="payment"]:checked').value;

        if (orderList.length === 0) {
            alert('Please add products to your order_routes.');
            return;
        }

        if (!paymentType) {
            alert('Please select a payment method.');
            return;
        }

        // Prepare order_routes data
        const orderData = {
            products: orderList,
            totalAmount: document.getElementById('total-amount').innerText,
            paymentType: paymentType
        };

        console.log('Order Submitted:', orderData);
        // Here, you would typically send the order_routes data to the backend using AJAX or form submission
    }

    function submitOrder(event) {
        event.preventDefault();

        let paymentType = document.querySelector('input[name="payment"]:checked').value;

        if (orderList.length === 0) {
            alert('Please add products to your order_routes.');
            return;
        }

        if (!paymentType) {
            alert('Please select a payment method.');
            return;
        }

        const orderData = {
            products: orderList,
            totalAmount: document.getElementById('total-amount').innerText,
            paymentType: paymentType
        };

        if (paymentType === 'Cash') {
            // Directly submit order_routes data for Cash payment
            fetch('/client/submitOrder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Order placed successfully!');
                        window.location.href = data.url;
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        } else if (paymentType === 'Credit Card' || paymentType === 'PayPal') {
            // Initiate Razorpay payment
            let options = {
                key: 'rzp_test_JWwpr1USWodaq9', // Replace with your Razorpay key
                amount: orderData.totalAmount * 100, // Amount in paise
                currency: 'INR',
                name: 'Your Store Name',
                description: 'Order Payment',
                image: 'https://example.com/your_logo.jpg',
                order_id: '', // This will be set after creating the order_routes on Razorpay
                handler: function (response) {
                    // Call your backend to verify the payment and store transaction details
                    fetch('/orders/submitOrder', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            products: orderList,
                            totalAmount: orderData.totalAmount,
                            paymentType: paymentType,
                            razorpay_payment_id: response.razorpay_payment_id,
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.status === 'success') {
                                alert('Order placed successfully!');
                            } else {
                                alert(data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                },
                prefill: {
                    name: 'Customer Name',
                    email: 'customer@example.com',
                    contact: '9999999999'
                },
                notes: {
                    address: 'Customer Address'
                },
                theme: {
                    color: '#F37254'
                }
            };

            const rzp1 = new Razorpay(options);
            rzp1.open();
        }
    }

    function changeQty(index, action, maxQty) {
        const inputField = document.getElementById(`quantity-${index}`);
        let currentQty = parseInt(inputField.value);

        if (action === 'increment') {
            // Check if we can increment without exceeding maxQty
            if (currentQty < maxQty) {
                currentQty += 1;
            }
        } else if (action === 'decrement') {
            // Ensure that the quantity is not decremented below 1
            if (currentQty > 1) {
                currentQty -= 1;
            }
        }

        // Update the input field with the new value
        inputField.value = currentQty;

        // Call the function to update the quantity elsewhere if needed
        updateQty(index, currentQty);
    }
</script>
<script src="/static/assets/js/jquery-3.6.0.min.js"></script>
<script src="/static/assets/js/feather.min.js"></script>
<script src="/static/assets/js/jquery.slimscroll.min.js"></script>
<script src="/static/assets/js/bootstrap.bundle.min.js"></script>
<script src="/static/assets/js/jquery.dataTables.min.js"></script>
<script src="/static/assets/js/dataTables.bootstrap4.min.js"></script>
<script src="/static/assets/plugins/select2/js/select2.min.js"></script>
<script src="/static/assets/plugins/owlcarousel/owl.carousel.min.js"></script>
<script src="/static/assets/plugins/sweetalert/sweetalert2.all.min.js"></script>
<script src="/static/assets/plugins/sweetalert/sweetalerts.min.js"></script>
<script src="/static/assets/js/script.js"></script>
</body>
</html>